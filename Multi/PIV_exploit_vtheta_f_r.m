clear all;close all;


minDelay=[480,440,400,360,320,280,260,624,810,1054,1370,1782,2316,3012,220,180,140,110,80]*10^(-6);
minDelayus=minDelay*10^6;
minDelayus=sort(minDelayus);

fps=35;
nbtour4=[2,4,3,6,8,10,4,9,5,2,3,3,2,2,13,5,8,11,19];
deltaim4=[9,17,12,22,27,31,12,50,34,17,32,41,35,45,35,12,17,21,32];
frqbarreau=1./(deltaim4./nbtour4./fps);
frqbarreau=fliplr(sort(frqbarreau));
run('E:\Clément\phdcodes\Multi\manipspiv.m');
coefs=[];
freqs=[];
mins=[];
for numVid=17
    
    basePathVid=strjoin(basePathVidCatalogue(numVid));
    video=strjoin(videoCatalogue(numVid));
    sete=strjoin(setCatalogue(numVid));
    startImg=startImgCatalogue(numVid);
    date=strjoin(dateCatalogue(numVid));
    % build paths and create directories
    directoryVid=strcat(basePathVid,date,sete,video);
    directoryPiv=strcat(directoryVid,'piv3\');
    load(strcat(directoryPiv,'PIV_mean_mask.mat'))
    
    Umoy=Umoy*calibCat(numVid)*30;
    Vmoy=Vmoy*calibCat(numVid)*30;
    x=x*calibCat(numVid);
    y=y*calibCat(numVid);
    rlist=[];
    vtlist=[];
    numxvort=2;
    numyvort=2;
    test=(x>(6.05+24.1*numxvort)) & (y>(6.05+24.1*numxvort)) & (x<(6.05+24.1*(numxvort+1))) & (y<(6.05+24.1*(numxvort+1)));
    Uvort=reshape(sqrt(Umoy(test).^2+Vmoy(test).^2),[sqrt(length(sqrt(Umoy(test).^2+Vmoy(test).^2))),sqrt(length(sqrt(Umoy(test).^2+Vmoy(test).^2)))]);
    xinterp=linspace(6.05+24.1*numxvort+6,6.05+24.1*(numxvort+1)-6,200);
    yinterp=linspace(6.05+24.1*numyvort+6,6.05+24.1*(numyvort+1)-6,200);
    [X,Y]=meshgrid(xinterp,yinterp);
    ampinterp=interp2(reshape(x(test),[sqrt(length(sqrt(Umoy(test).^2+Vmoy(test).^2))),sqrt(length(sqrt(Umoy(test).^2+Vmoy(test).^2)))]),reshape(y(test),[sqrt(length(sqrt(Umoy(test).^2+Vmoy(test).^2))),sqrt(length(sqrt(Umoy(test).^2+Vmoy(test).^2)))]),Uvort,X,Y);
    idxmin=find(ampinterp==min(min(ampinterp)));
    posx=X(idxmin);
    posy=Y(idxmin);
    for i=1:length(Umoy)
        for j=1:length(Umoy)
            r=sqrt((x(i,j)-posx)^2+(y(i,j)-posy)^2);
            if r<16
                erx=x(i,j)-posx;
                ery=-(y(i,j)-posy);
                theta=atan(ery/erx);
                if erx<0
                    theta=theta+pi;
                end
                vtheta=-sin(theta)*Umoy(i,j)+cos(theta)*Vmoy(i,j);
                if mod(numxvort+numyvort,2)==0
                    vtheta=-vtheta;
                end
                rlist=[rlist,r];
                vtlist=[vtlist,vtheta];
            end
        end
    end
    p=polyfit(rlist(rlist<8),vtlist(rlist<8),1);
   figure;
    plot(rlist,vtlist,'+');
    hold on;
    plot(linspace(0,8,2),p(1)*linspace(0,8,2)+p(2),'-r')
    xlabel('R [mm]')
    ylabel('v_{theta}')
    title(strcat(num2str(interp1(minDelayus,frqbarreau,str2double(videoCatalogue{numVid}(1:end-1)))),' Hz'))
    coefs=[coefs,p(1)];
    freqs=[freqs,interp1(minDelayus,frqbarreau,str2double(videoCatalogue{numVid}(1:end-1)))];
    mins=[mins,mean(mean(sqrt(Umoy.^2+Vmoy.^2)))];
end


figure;plot(freqs,coefs,'+');
xlabel('Fréquence [Hz]')
ylabel('Coef [s$^{-1}$]','Interpreter','latex')
xlim([0,12])
ylim([0,1.4])




%
% for numVid=21%4:7
%
%     basePathVid=strjoin(basePathVidCatalogue(numVid));
%     video=strjoin(videoCatalogue(numVid));
%     sete=strjoin(setCatalogue(numVid));
%     startImg=startImgCatalogue(numVid);
%     date=strjoin(dateCatalogue(numVid));
%     % build paths and create directories
%     directoryVid=strcat(basePathVid,date,sete,video);
%     directoryPiv=strcat(directoryVid,'piv2\');
%     load(strcat(directoryPiv,'PIV_mean_mask.mat'))
%     if cpt==0
%         Umoyt=zeros(size(Umoy));
%         Vmoyt=zeros(size(Umoy));
%         cut=zeros(size(Umoy));
%         cvt=zeros(size(Umoy));
%         cpt=cpt+1;
%     end
%     Umoyt=Umoyt+Umoy.*countsu;
%     Vmoyt=Vmoyt+Vmoy.*countsv;
%     cut=cut+countsu;
%     cvt=cvt+countsv;
%
% end
% Umoyt=Umoyt./cut;
% Vmoyt=Vmoyt./cvt;
% Umoy=Umoyt*calibCat(numVid)*30;
% Vmoy=Vmoyt*calibCat(numVid)*30;
% x=x*calibCat(numVid);
% y=y*calibCat(numVid);
% rlist=[];
% vtlist=[];
% for i=1:length(Umoy)
%     for j=1:length(Umoy)
%         if isfinite(Umoy(i,j)) && x(i,j)>6.05 && y(i,j)>6.05 && x(i,j)<6.05+96.4 && y(i,j)<6.05+96.4
%             numxvort=fix((x(i,j)-6.05)/24.1);
%             numyvort=fix((y(i,j)-6.05)/24.1);
%             if numxvort==0 && numyvort==1
%                 posx=6.05+24.1/2+24.1*numxvort;
%                 posy=6.05+24.1/2+24.1*numyvort;
%                 posx=15;
%                 posy=42.5;
%                 r=sqrt((x(i,j)-posx)^2+(y(i,j)-posy)^2);
%                 erx=x(i,j)-posx;
%                 ery=-(y(i,j)-posy);
%                 theta=atan(ery/erx);
%                 if erx<0
%                     theta=theta+pi;
%                 end
%                 vtheta=-sin(theta)*Umoy(i,j)+cos(theta)*Vmoy(i,j);
%                 if mod(numxvort+numyvort,2)==0
%                     vtheta=-vtheta;
%                 end
%                 rlist=[rlist,r];
%                 vtlist=[vtlist,vtheta];
%             end
%         end
%     end
% end
% plot(rlist,vtlist,'+')
% xlabel('R [mm]')
% ylabel('v_{theta}')
